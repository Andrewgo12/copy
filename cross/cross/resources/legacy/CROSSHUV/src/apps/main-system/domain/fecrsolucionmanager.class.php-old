<?php

/**
 * @Copyright 2005 Parquesoft
 *
 * Clase manager de la tabla archivos
 * @author Ingravity 0.0.9
 * @location Cali - Colombia
 */
class FeCrSolucionManager{

	/**
	 * @Copyright 2005 Parquesoft
	 *
	 * Metodo constructor tabla: archivos
	 * @author Ingravity 0.0.9
	 * @location Cali - Colombia
	 */
	function FeCrSolucionManager(){
		$this->gatewayOrdenempresa = Application::getDataGateway("Ordenempresa");
		$this->gatewayOrden = Application::getDataGateway("Orden");
		$this->gatewayext = Application::getDataGateway("OrdenExtended");
	}

	/**
	 * @Copyright 2005 Parquesoft
	 *
	 * Metodo adicion de una solucion
	 * @author Ingravity 0.0.9
	 * @location Cali - Colombia
	 */
	function addSolucion($ordenumeros,$resumen){
			
		settype($rcReq, "array");
		settype($rcSql, "array");
		settype($sbResult, "string");
			
		$rcReq = $this->gatewayOrden->getByIdOrden($ordenumeros);
			
		if(is_array($rcReq) && $rcReq){

			//Valida que el requermimiento este finalizado
			if(!$rcReq[0]["ordefecfinad"]){
				return 40;
			}

			//Consulta el req de ordenempresa
			$rcReq = $this->gatewayOrdenempresa->getByIdOrdenempresa($ordenumeros);

			//Valida si el req ya tiene solución
			if($rcReq[0]['oremsolucios']){
				return 41;
			}

			//Actualiza ordenempresa
			$this->gatewayOrdenempresa->updateOrdenempresaSolucios($ordenumeros,$resumen);
			if($this->gatewayOrdenempresa->consult == false){
				return 42;
			}

			//se actualizan los archivos anexos
			$rcSql = $this->addFiles($ordenumeros);

			if(is_array($rcSql) && $rcSql){

				$this->gatewayext->OrdenTrans($rcSql);
				$sbResult = $this->gatewayext->consult;

				if($sbResult){
					//llamada al metodo que actualiza los archivos a disco duro
					$this->setFiles();
				}
			}

			$this->UnsetRequest();
			$this->unsetAttachment();
			return 3;
		}else{
			return 39;
		}
	}

	/**
	 * @Copyright 2005 Parquesoft
	 *
	 * Metodo de actualizacion de datos tabla: archivos
	 * @author Ingravity 0.0.9
	 * @location Cali - Colombia
	 */
	function updateSolucion($ordenumeros,$resumen){

		settype($rcReq, "array");
		settype($rcSql, "array");
		settype($sbResult, "string");

		$rcReq = $this->gatewayOrden->getByIdOrden($ordenumeros);

		if(is_array($rcReq) && $rcReq){

			//Valida que el requermimiento este finalizado
			if(!$rcReq[0]["ordefecfinad"]){
				return 40;
			}

			//Consulta el req de ordenempresa
			$rcReq = $this->gatewayOrdenempresa->getByIdOrdenempresa($ordenumeros);

			//Valida si el req no tiene solución
			if(!$rcReq[0]['oremsolucios']){
				return 44;
			}

			//Actualiza ordenempresa
			$this->gatewayOrdenempresa->updateOrdenempresaSolucios($ordenumeros,$resumen);

			if($this->gatewayOrdenempresa->consult == false){
				return 42;
			}

			//se actualizan los archivos anexos
			$rcSql = $this->updateFiles($ordenumeros);

			if(is_array($rcSql) && $rcSql){

				$this->gatewayext->OrdenTrans($rcSql);
				$sbResult = $this->gatewayext->consult;

				if($sbResult){
					//llamada al metodo que actualiza los archivos a disco duro
					$this->setFiles();
				}
			}


			$this->UnsetRequest();
			$this->unsetAttachment();
			return 3;
		}else{
			return 39;
		}
	}

	/**
	 * @Copyright 2005 Parquesoft
	 *
	 * Metodo de eliminacion de datos tabla: archivos
	 * @author Ingravity 0.0.9
	 * @location Cali - Colombia
	 */
	function deleteSolucion($ordenumeros){

		settype($objService, "object");
		settype($objManager, "object");
		settype($rcReq, "array");
		settype($rcTipos, "array");
		settype($rcSql, "array");
		settype($sbResult, "string");


		$rcReq = $this->gatewayOrden->getByIdOrden($ordenumeros);

		if(is_array($rcReq) && $rcReq){

			//Valida que el requermimiento este finalizado
			if(!$rcReq[0]["ordefecfinad"]){
				return 40;
			}

			//Consulta el req de ordenempresa
			$rcReq = $this->gatewayOrdenempresa->getByIdOrdenempresa($ordenumeros);

			//Valida si el req no tiene solución
			if(!$rcReq[0]['oremsolucios']){
				return 44;
			}

			//Actualiza ordenempresa
			$this->gatewayOrdenempresa->updateOrdenempresaSolucios($ordenumeros,null);

			if($this->gatewayOrdenempresa->consult == false){
				return 42;
			}

			//actualiza el archvo
			$objService = Application::loadServices('General');
			$rcTipos = $objService->getConstant('TIPO_FILE');
			//se eliminan lo archivos anteriores si los hay
			$objService = Application::loadServices('General');
			$objManager = $objService->InitiateClass('ArchivosManager');
			$this->sbThread = $objManager->getThread();
			$rcSql= $objManager->deleteSqlArchivos($rcTipos["solucion"],$ordenumeros,null);
			$objService->close();
				
			if(is_array($rcSql) && $rcSql){

				$this->gatewayext->OrdenTrans($rcSql);
				$sbResult = $this->gatewayext->consult;

				if($sbResult){
					//llamada al metodo que actualiza los archivos a disco duro
					$this->setFiles();
				}
			}

			if($sbResult == false){
				$objService->close();
				$this->gatewayOrdenempresa->updateOrdenempresaSolucios($ordenumeros,$rcReq[0]['oremsolucios']);
				return 43;
			}
			$this->UnsetRequest();
			$this->unsetAttachment();
			return 3;
		}else{
			return 39;
		}
	}
	/**
	 * @Copyright 2005 Parquesoft
	 *
	 * Metodo para limpiar los datos de la sesion de la tabla: archivos
	 * @author Ingravity 0.0.9
	 * @location Cali - Colombia
	 */
	function UnsetRequest(){
		unset($_REQUEST["ordenempresa__ordenumeros"]);
		unset($_REQUEST["solucion__ordenumeros"]);
		unset($_REQUEST["solucion__resumen"]);
	}

	/**
	 * Copyright 2007 FullEngine
	 *
	 * limpia lo archivos anexos
	 * @author freina<freina@parquesoft.com>
	 * @return boolean true
	 * @date 02-Jun-2007 10:59
	 * @location Cali-Colombia
	 */
	function unsetAttachment(){

		settype($rcFileName,"array");
		settype($rcTmp,"array");
		settype($nuCont,"integer");

		if ((WebSession :: issetProperty("_rcSolucionFileList"))) {
			//se obtienen los archivos ya guardados
			$rcFileName = WebSession :: getProperty("_rcSolucionFileList");
			foreach ($rcFileName as $nuCont => $rcTmp) {
				if(!$rcTmp["id"]){
					WebSession :: unsetProperty($rcTmp["index"]);
				}
			}
			WebSession :: unsetProperty("_rcSolucionFileList");
		}
	}

	/**
	 * @copyright Copyright 2007 FullEngine
	 *
	 * Ingresa los archivos anexos
	 * @param string $sbOrdenumeros Cadena con el numero del caso
	 * @return boolean true o false
	 * @author freina <freina@parquesoft.com>
	 * @date 02-Jun-2007 10:59
	 * @location Cali-Colombia
	 */
	function addFiles($sbOrdenumeros) {

		settype($objService, "object");
		settype($objManager, "object");
		settype($rcTipos, "array");
		settype($rcTmp, "array");
		settype($rcFileName, "array");
		settype($rcSql, "array");
		settype($rcResult, "array");
		settype($sbTipo, "string");
		settype($nuArchcodigon, "integer");
		settype($nuCant, "integer");
		settype($nuCont, "integer");


		if($sbOrdenumeros){

			//se obtienen los archivos ya guardados
			$rcFileName = WebSession :: getProperty("_rcSolucionFileList");

			if($rcFileName && is_array($rcFileName)){

				$nuCant = sizeof($rcFileName);

				//graba el archivo
				$objNumerador = Application :: getDomainController('NumeradorManager');
				$nuArchcodigon = $objNumerador->fncgetByIdNumerador("archivos",$nuCant);
				$objService = Application::loadServices('General');
				$rcTipos = $objService->getConstant('TIPO_FILE');
				$objService = Application::loadServices('General');
				$objManager = $objService->InitiateClass('ArchivosManager');
				$this->sbThread = $objManager->getThread();
				$sbTipo = $rcTipos["solucion"];
				foreach($rcFileName as $nuCont=>$rcTmp){
					$rcSql = $objManager->addSqlArchivos($nuArchcodigon,
					$sbTipo,$sbOrdenumeros,$rcTmp["name"],$rcTmp["type"],
					$rcTmp["size"],WebSession :: getProperty($rcTmp["index"]),$rcTmp["ext"]);
					$nuArchcodigon ++;

					if($rcSql){
						$rcResult = array_merge($rcResult,$rcSql);
					}
				}
				$objService->close();
			}
		}
		return $rcResult;
	}

	/**
	 * @copyright Copyright 2014 FullEngine
	 *
	 * Actualiza los registro de archivo
	 * @return boolean true o false
	 * @author freina <freina@fullengine.com>
	 * @date 27-Jun-2015 13:44
	 * @location Cali-Colombia
	 */
	function setFiles(){

		settype($objService, "object");
		settype($objManager, "object");
		settype($rcResult, "array");

		if($this->sbThread){
			$objService = Application::loadServices('General');
			$objManager = $objService->InitiateClass('ArchivosManager');
			$objManager->setThread($this->sbThread);
			$objManager->setArchivoaux();
			$rcResult = $objManager->getResult();
			$objService->close();
		}

		return $rcResult["result"];

	}

	/**
	 * @copyright Copyright 2007 FullEngine
	 *
	 * Actualiza los archivos anexos
	 * @param string $sbOrdenumeros Cadena con el numero del caso
	 * @return boolean true o false
	 * @author freina <freina@parquesoft.com>
	 * @date 02-Jun-2007 10:59
	 * @location Cali-Colombia
	 */
	function updateFiles($sbOrdenumeros) {

		settype($objService, "object");
		settype($objManager, "object");
		settype($rcTipos, "array");
		settype($rcTmp, "array");
		settype($rcFileName, "array");
		settype($rcFileN, "array");
		settype($rcFileO, "array");
		settype($rcFileDB, "array");
		settype($rcSql, "array");
		settype($rcResult, "array");
		settype($sbTipo, "string");
		settype($nuArchcodigon, "integer");
		settype($nuCant, "integer");
		settype($nuCont, "integer");


		if($sbOrdenumeros){

			//se obtienen los archivos ya guardados
			$rcFileName = WebSession :: getProperty("_rcSolucionFileList");

			if($rcFileName && is_array($rcFileName)){

				//se separan los archivos nuevos y los viejos
				foreach($rcFileName as $rcTmp){
					if($rcTmp["id"]){
						$rcFileO[]=$rcTmp["id"];
					}else{
						$rcFileF[]=$rcTmp;
					}
				}
			}


			$objService = Application::loadServices('General');
			$rcTipos = $objService->getConstant('TIPO_FILE');
			$sbTipo = $rcTipos["solucion"];

			//se eliminan lo archivos anteriores si los hay
			$objService = Application::loadServices('General');
			$objManager = $objService->InitiateClass('ArchivosManager');
			$this->sbThread = $objManager->getThread();
			$rcFileDB = $objManager->getByRefArchivos($sbTipo,$sbOrdenumeros);

			if($rcFileDB){
				$rcResult= $objManager->deleteSqlArchivos($sbTipo,$sbOrdenumeros,$rcFileO);
			}

			$objService->close();

			if($rcFileF){
				$nuCant = sizeof($rcFileF);
				$objNumerador = Application :: getDomainController('NumeradorManager');
				$nuArchcodigon = $objNumerador->fncgetByIdNumerador("archivos",$nuCant);
				$objService = Application::loadServices('General');
				$objManager = $objService->InitiateClass('ArchivosManager');
				$objManager->setThread($this->sbThread);

				//graba el archivo
				//se almacenan los nuevos
				foreach($rcFileF as $nuCont=>$rcTmp){
					$rcSql = $objManager->addSqlArchivos($nuArchcodigon,
					$sbTipo,$sbOrdenumeros,$rcTmp["name"],$rcTmp["type"],
					$rcTmp["size"],WebSession :: getProperty($rcTmp["index"]),$rcTmp["ext"]);

					$nuArchcodigon ++;

					if($rcSql){
						$rcResult = array_merge($rcResult,$rcSql);
					}
				}
				$objService->close();
			}

		}
		return $rcResult;
	}
}
?>
